#!/usr/bin/env python3

from elftools.elf.elffile import ELFFile
from elftools.elf.relocation import RelocationSection
from elftools.elf.sections import SymbolTableSection
from collections import defaultdict


def symbol_info(elf):
   # Dictionary to hold symbol name -> (defined status, type)
    sym_info = {}
    for section in elf.iter_sections():
        if not isinstance(section, SymbolTableSection): # .symtab or .dynsym
            continue
        for symbol in section.iter_symbols():
            name = symbol.name
            if (not name) or (name in sym_info):
                continue  # Skip unnamed symbols and duplicates

            if symbol['st_info']['bind'] == 'STB_LOCAL':
                continue  # Skip local symbols

            defined = symbol['st_shndx'] != 'SHN_UNDEF'
            st_type = symbol['st_info']['type']

            sym_info[name] = {
                'defined': defined,
                'type': st_type
            }
    return sym_info


def relocation_counts(elf):
    # Dictionary to hold symbol name -> count of relocations referencing it
    reloc_count = defaultdict(int)
    for section in elf.iter_sections():
        if not isinstance(section, RelocationSection):
            continue
        symtab = elf.get_section(section['sh_link'])
        assert(isinstance(symtab, SymbolTableSection))
        for reloc in section.iter_relocations():
            sym_index = reloc.entry.r_info_sym
            symbol = symtab.get_symbol(sym_index)
            name = symbol.name
            if not name:
                continue  # Skip unnamed symbols
            reloc_count[name] += 1
    return reloc_count


from collections import namedtuple
ObjectSymbols = namedtuple('ObjectSymbols', ['locals', 'globals'])

def object_symbols(elf):
    # Step 1: Parse symbol tables to get symbol definitions
    sym_info = symbol_info(elf)

    # Step 2: Parse relocation tables to count symbol usage
    reloc_count = relocation_counts(elf)

    # Step 3: Separate into defined (locals) and undefined (globals) symbols
    locals  = []
    globals = []
    for name in sym_info:
        info = sym_info[name]
        if info['defined']:
            locals.append(name)
        else:
            count = reloc_count.get(name, 0)
            entry = {
                'name': name,
                # 'type': info['type'],
                'reloc_count': count,
                'obj': []
            }
            globals.append(entry)
    return ObjectSymbols(locals, globals)


def main():
    import sys
    import os

    if len(sys.argv) != 2:
        print("Usage: python script.py <object_file>|<object_directory>")
        return

    path = sys.argv[1]
    if os.path.isfile(path):
        with open(path, 'rb') as f:
            symbols = object_symbols(f)

        print(f"Known (Defined) Symbols ({len(symbols.locals)}):")
        for name in symbols.locals:
            print(f"  Name: {name}")

        print(f"\nUnknown (Undefined) Symbols ({len(symbols.globals)}):")
        for entry in symbols.globals:
            print(f"  Name: {entry['name']}, "
                  f"Used in Relocations: {entry['reloc_count']}")

    elif os.path.isdir(path):
        from pathlib import Path
        import json

        dir = Path(path)
        # Get all .o files
        OBJECT_FILES = [f.name for f in dir.iterdir() if f.name.endswith('.o')]

        # Map symbol name -> list[object files that define it]
        symbol_objects_map: dict[str, list[str]] = {}
        # Map object file -> tuple(local symbol names, global symbol entries)
        object_symbols_map: dict[str, ObjectSymbols] = {}

        # First pass: collect symbol definitions
        for obj in OBJECT_FILES:
            print(obj)
            with open(dir / obj, 'rb') as f:
                elf = ELFFile(f)
                symbols = object_symbols(elf)
                object_symbols_map[obj] = symbols
                for sym in symbols.locals:
                    if sym not in symbol_objects_map:
                        symbol_objects_map[sym] = []
                    symbol_objects_map[sym].append(obj)

        # Second pass: collect object names where globals defined
        for obj, symbols in object_symbols_map.items():
            for sym in symbols.globals:
                if sym['name'] not in symbol_objects_map:
                    continue
                sym['obj'].extend(symbol_objects_map[sym['name']])

        with open('objects.json', 'w') as json_file:
            json.dump(object_symbols_map, json_file, indent=2)

    else:
        print(f"'{path}' does not exist or is not a file/directory.")
        exit(1)

if __name__ == '__main__':
    main()
